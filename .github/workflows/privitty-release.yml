name: Privitty – Build Release Artifacts

# Produces UNSIGNED artifacts for all platforms.
# No Apple or Windows signing credentials are stored in CI.
# A developer downloads the artifacts and signs them locally using:
#   macOS   → build/sign-mac.sh
#   Windows → build/sign-win.ps1
#
# Triggers:
#   • Push of a version tag:  git tag v1.2.3 && git push origin v1.2.3
#   • Manual run via GitHub Actions UI (workflow_dispatch)

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g. 1.2.3). Leave blank to use package.json.'
        required: false
        default: ''

jobs:

  # ── macOS: universal DMG (unsigned) ──────────────────────────────────────
  build-mac:
    name: macOS – universal DMG (unsigned)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Override version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: packages/target-electron
        run: |
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json','utf8'));
            p.version = '${{ github.event.inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Build JS/TS sources
        run: pnpm -w build:electron

      - name: Create universal fat binaries (lipo)
        working-directory: packages/target-electron
        run: node ./build/create-universal-bins.cjs

      - name: Generate electron-builder config (unsigned, universal)
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          UNIVERSAL_BUILD: 'true'
        run: node ./build/gen-electron-builder-config.js

      - name: Patch node_modules
        working-directory: packages/target-electron
        run: node ../../bin/writeFlatDependencies.js packages/target-electron node_modules

      - name: Build unsigned universal DMG
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: |
          electron-builder \
            --config ./electron-builder.json5 \
            --mac dmg \
            --universal \
            --publish never

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: privitty-macos-unsigned
          path: packages/target-electron/dist/*.dmg
          retention-days: 30

  # ── Windows: NSIS installer + portable (unsigned) ────────────────────────
  build-windows:
    name: Windows – installer + portable (unsigned)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Override version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: packages/target-electron
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json','utf8'));
            p.version = '${{ github.event.inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Build JS/TS sources
        run: pnpm -w build:electron

      - name: Generate electron-builder config (unsigned)
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          CSC_LINK: ''
        run: node ./build/gen-electron-builder-config.js

      - name: Patch node_modules
        working-directory: packages/target-electron
        run: node ../../bin/writeFlatDependencies.js packages/target-electron node_modules

      - name: Build unsigned Windows installer
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          CSC_LINK: ''
        run: |
          electron-builder `
            --config ./electron-builder.json5 `
            --win nsis portable `
            --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: privitty-windows-unsigned
          path: packages/target-electron/dist/*.exe
          retention-days: 30

  # ── Linux: AppImage + deb (no signing required) ───────────────────────────
  build-linux:
    name: Linux – AppImage + deb
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libnss3-dev libgtk-3-dev libxss1 libasound2-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Override version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: packages/target-electron
        run: |
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json','utf8'));
            p.version = '${{ github.event.inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Build JS/TS sources
        run: pnpm -w build:electron

      - name: Generate electron-builder config
        working-directory: packages/target-electron
        run: node ./build/gen-electron-builder-config.js

      - name: Patch node_modules
        working-directory: packages/target-electron
        run: node ../../bin/writeFlatDependencies.js packages/target-electron node_modules

      - name: Build Linux packages
        working-directory: packages/target-electron
        run: |
          electron-builder \
            --config ./electron-builder.json5 \
            --linux AppImage deb \
            --publish never

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: privitty-linux
          path: |
            packages/target-electron/dist/*.AppImage
            packages/target-electron/dist/*.deb
          retention-days: 30
