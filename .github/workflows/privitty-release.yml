name: Privitty – Build Release Artifacts

# Produces UNSIGNED artifacts for all platforms.
# No Apple or Windows signing credentials are stored in CI.
# A developer downloads the artifacts and signs them locally using:
#   macOS   → build/sign-mac.sh
#   Windows → build/sign-win.ps1
#
# Triggers:
#   • Push of a version tag:  git tag v1.2.3 && git push origin v1.2.3
#   • Manual run via GitHub Actions UI (workflow_dispatch)

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g. 1.2.3). Leave blank to use package.json.'
        required: false
        default: ''

jobs:

  # ── macOS: universal DMG (unsigned) ──────────────────────────────────────
  build-mac:
    name: macOS – universal DMG (unsigned)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # Install ALL optional packages for both arm64 and x64 so lipo can
      # combine them into a universal fat binary.  The root package.json already
      # declares supportedArchitectures: { cpu: [x64, arm64] }, so pnpm will
      # download both sets of optional deps automatically.
      - name: Install dependencies (both architectures)
        run: pnpm install --frozen-lockfile

      - name: Override version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: packages/target-electron
        run: |
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json','utf8'));
            p.version = '${{ github.event.inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Build JS/TS sources
        run: pnpm -w build:electron

      # Must run BEFORE create-universal-bins.cjs so that the flat
      # packages/target-electron/node_modules/@privitty/* directories exist.
      - name: Flatten node_modules (patch)
        working-directory: packages/target-electron
        run: node ../../bin/writeFlatDependencies.js packages/target-electron node_modules

      - name: Create universal fat binaries (lipo)
        working-directory: packages/target-electron
        run: node ./build/create-universal-bins.cjs

      # Delete ALL arch-specific packages from the flat node_modules BEFORE
      # electron-builder runs.  electron-builder builds the ASAR header from
      # whatever is in node_modules.  If arch-specific packages (e.g.
      # @parcel/watcher-darwin-x64) are present, they get listed in the ASAR
      # header as "unpacked" files.  The afterPackHook then deletes them from
      # app.asar.unpacked, but the ASAR header still references them.  When
      # @electron/universal's mergeASARs step tries to read those files it
      # gets ENOENT and fails.
      #
      # By removing them here (after lipo has already created the universal
      # fat binaries), only the -darwin-universal packages remain and both
      # build slices end up with identical ASAR headers.
      - name: Pre-cleanup arch-specific packages (universal build)
        working-directory: packages/target-electron
        run: |
          rm -rf \
            node_modules/@parcel/watcher-darwin-arm64 \
            node_modules/@parcel/watcher-darwin-x64 \
            node_modules/@parcel/watcher-linux-arm64 \
            node_modules/@parcel/watcher-linux-x64 \
            node_modules/@parcel/watcher-win32-arm64 \
            node_modules/@parcel/watcher-win32-ia32 \
            node_modules/@parcel/watcher-win32-x64 \
            node_modules/@privitty/deltachat-rpc-server-darwin-arm64 \
            node_modules/@privitty/deltachat-rpc-server-darwin-x64 \
            node_modules/@privitty/privitty-core-darwin-arm64 \
            node_modules/@privitty/privitty-core-darwin-x64 \
            node_modules/@privitty/privitty-core-linux-arm64 \
            node_modules/@privitty/privitty-core-linux-x64 \
            node_modules/@privitty/privitty-core-win32-arm64 \
            node_modules/@privitty/privitty-core-win32-x64 \
            || true
          echo "Pre-cleanup done. Remaining @parcel/watcher and @privitty packages:"
          ls node_modules/@parcel/ 2>/dev/null || echo "  (none)"
          ls node_modules/@privitty/ 2>/dev/null || echo "  (none)"

      - name: Generate electron-builder config (unsigned, universal)
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          UNIVERSAL_BUILD: 'true'
        run: node ./build/gen-electron-builder-config.js

      - name: Build unsigned universal DMG
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          UNIVERSAL_BUILD: 'true'
        run: |
          pnpm exec electron-builder \
            --config ./electron-builder.json5 \
            --mac dmg \
            --universal \
            --publish never

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: privitty-macos-unsigned
          path: packages/target-electron/dist/*.dmg
          retention-days: 30

  # ── Windows: NSIS installer + portable (unsigned) ────────────────────────
  build-windows:
    name: Windows – installer + portable (unsigned)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Override version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: packages/target-electron
        shell: bash
        run: |
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json','utf8'));
            p.version = '${{ github.event.inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Build JS/TS sources
        run: pnpm -w build:electron

      - name: Generate electron-builder config (unsigned)
        working-directory: packages/target-electron
        shell: bash
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          CSC_LINK: ''
        run: node ./build/gen-electron-builder-config.js

      - name: Flatten node_modules (patch)
        working-directory: packages/target-electron
        shell: bash
        run: node ../../bin/writeFlatDependencies.js packages/target-electron node_modules

      - name: Build unsigned Windows installer
        working-directory: packages/target-electron
        shell: bash
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
          CSC_LINK: ''
        run: |
          pnpm exec electron-builder \
            --config ./electron-builder.json5 \
            --win nsis portable \
            --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: privitty-windows-unsigned
          path: packages/target-electron/dist/*.exe
          retention-days: 30

  # ── Linux: AppImage + deb (no signing required) ───────────────────────────
  build-linux:
    name: Linux – AppImage + deb
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libnss3-dev libgtk-3-dev libxss1 libasound2-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Override version
        if: ${{ github.event.inputs.version != '' }}
        working-directory: packages/target-electron
        run: |
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json','utf8'));
            p.version = '${{ github.event.inputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Build JS/TS sources
        run: pnpm -w build:electron

      - name: Generate electron-builder config
        working-directory: packages/target-electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: node ./build/gen-electron-builder-config.js

      - name: Flatten node_modules (patch)
        working-directory: packages/target-electron
        run: node ../../bin/writeFlatDependencies.js packages/target-electron node_modules

      - name: Build Linux packages
        working-directory: packages/target-electron
        run: |
          pnpm exec electron-builder \
            --config ./electron-builder.json5 \
            --linux AppImage deb \
            --publish never

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: privitty-linux
          path: |
            packages/target-electron/dist/*.AppImage
            packages/target-electron/dist/*.deb
          retention-days: 30
